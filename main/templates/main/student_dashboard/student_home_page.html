{% extends 'main/student_dashboard/student_base.html' %}
{% load static %}
{% block title %}Панель ученика - Школьная Столовая{% endblock %}
{% block body %}

<section class="today-menu">
  <div class="section-header">
    <h2><i class="fas fa-concierge-bell"></i> Меню на сегодня</h2>

  </div>

  <!-- Список блюд -->
  <div class="menu-items">
    {% for card in today_cards %}
    <div class="menu-item" data-meal-type="{{ card.meal_type }}">
      <h4>{{ card.title }}</h4>
      <p class="text-muted">{{ card.description|default:"Без описания" }}</p>
        <span class="badge {{ card.badge_class }}">
          {{ card.get_meal_type_display }}
        </span>
      <a href="{% url 'student_order_create' card.id %}" class="btn btn-sm btn-outline-primary mt-2">
        Заказать
      </a>
    </div>
    {% empty %}
    <p class="text-muted">Сегодня меню не загружено.</p>
    {% endfor %}
  </div>
</section>

<section class="my-orders">
  <h2><i class="fas fa-history"></i> Последние заказы</h2>
  {% if orders %}
    <div class="orders-list">
      {% for order in orders %}
        <div class="order-item">
          <div class="order-info">
            <h4>{{ order.card.title|default:"[Удалено]" }}</h4>
            <p class="text-muted">{{ order.ordered_at|date:"d.m.Y H:i" }}</p>
          </div>
          <div class="order-status">
            {% if order.status == 'pending' %}
              <span class="badge bg-warning">Готовится</span>
            {% elif order.status == 'ready' %}
              <span class="badge bg-success">Готов! Заберите в столовой</span>
            {% elif order.status == 'received' %}
              <span class="badge bg-secondary">Получен</span>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
    {% if all_orders_count > 3 %}
      <div class="mt-3 text-center">
        <a href="{% url 'student_my_orders' %}" class="btn btn-outline-secondary">
          Перейти ко всем заказам
        </a>
      </div>
    {% endif %}
  {% else %}
    <p class="text-muted">У вас пока нет заказов.</p>
  {% endif %}
</section>


<div id="preferences" class="dashboard-section">
    <div class="preferences-container">
        <h2><i class="fas fa-heart"></i> Мои предпочтения</h2>
        <div class="preferences-form">
            <div class="form-group">
                <label><i class="fas fa-allergies"></i> Аллергии</label>
                <textarea id="allergiesInput" placeholder="Укажите ваши аллергии (например: лактоза, орехи, глютен)">лактоза</textarea>
            </div>
            <div class="form-group">
                <label><i class="fas fa-utensils"></i> Пищевые предпочтения</label>
                <textarea id="preferencesInput" placeholder="Укажите ваши предпочтения (например: вегетарианское, без сахара)"></textarea>
            </div>
            <div class="form-group">
                <label><i class="fas fa-ban"></i> Нелюбимые продукты</label>
                <textarea id="dislikesInput" placeholder="Продукты, которые вы не любите"></textarea>
            </div>
            <button class="btn btn-primary" onclick="savePreferences()">
                <i class="fas fa-save"></i> Сохранить предпочтения
            </button>
        </div>
    </div>
</div>

<div id="orderModal" class="modal">  <!--Заказы-->
    <div class="modal-content">
        <div class="modal-header">
            <h3>Оформление заказа</h3>
            <button class="close-modal" onclick="closeOrderModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="order-details">
                <h4 id="modalDishName">Омлет с овощами</h4>
                <p id="modalDishDesc">Питательный омлет с помидорами, перцем и зеленью</p>
                <p class="price">120 ₽</p>
            </div>

            <div class="order-options">
                <div class="form-group">
                    <label>Тип оплаты:</label>
                    <div class="payment-options">
                        <label class="radio-option">
                            <input type="radio" name="payment" value="single" checked onchange="updatePaymentType()">
                            <span>Разовый платёж</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="payment" value="subscription" onchange="updatePaymentType()">
                            <span>Использовать абонемент</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Количество:</label>
                    <div class="quantity-selector">
                        <button class="qty-btn" onclick="changeQuantity(-1)">-</button>
                        <input type="number" id="quantity" value="1" min="1" max="10" onchange="updateTotalPrice()">
                        <button class="qty-btn" onclick="changeQuantity(1)">+</button>
                    </div>
                </div>

                <div class="order-summary">
                    <p>Итого: <span id="totalPrice">120</span> ₽</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeOrderModal()">Отмена</button>
            <button class="btn btn-primary" onclick="placeOrder()">
                <i class="fas fa-check"></i> Подтвердить заказ
            </button>
        </div>
    </div>
</div>

<div id="reviewModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Оставить отзыв</h3>
            <button class="close-modal" onclick="closeReviewModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Блюдо:</label>
                <select id="reviewDish">
                    <option>Омлет с овощами</option>
                    <option>Каша овсяная</option>
                    <option>Суп куриный</option>
                    <option>Плов</option>
                </select>
            </div>
            <div class="form-group">
                <label>Оценка:</label>
                <div class="rating-stars" id="ratingStars">
                    <i class="far fa-star" data-rating="1"></i>
                    <i class="far fa-star" data-rating="2"></i>
                    <i class="far fa-star" data-rating="3"></i>
                    <i class="far fa-star" data-rating="4"></i>
                    <i class="far fa-star" data-rating="5"></i>
                </div>
                <input type="hidden" id="ratingValue" value="0">
            </div>
            <div class="form-group">
                <label>Комментарий:</label>
                <textarea id="reviewComment" rows="4" placeholder="Поделитесь вашим мнением о блюде..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeReviewModal()">Отмена</button>
            <button class="btn btn-primary" onclick="submitReview()">
                <i class="fas fa-paper-plane"></i> Отправить отзыв
            </button>
        </div>
    </div>
</div>
<script>
function markAsReady(event, orderId) {
  event.preventDefault();
  const form = event.target;
  fetch('', {
    method: 'POST',
    body: new FormData(form),
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      document.getElementById('order-' + orderId).remove();
      // Если после удаления заказов не осталось — можно показать сообщение
      if (!document.querySelector('.order-item')) {
        const ordersList = document.querySelector('.orders-list');
        ordersList.innerHTML = '<p class="text-muted">Нет активных заказов.</p>';
      }
    }
  });
}

// Функция для отметки всех заказов готовыми
function markAllPrepared() {
  const forms = document.querySelectorAll('form[method="post"]');
  forms.forEach(form => {
    fetch('', {
      method: 'POST',
      body: new FormData(form),
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload(); // Перезагружаем страницу, чтобы обновить список
      }
    });
  });
}
</script>
{% endblock %}