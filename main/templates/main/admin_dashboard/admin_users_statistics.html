{% extends 'main/admin_dashboard/admin_base.html' %}
{% load static %}
{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π{% endblock %}
{% block body %}
<div class="container py-4">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-primary fw-bold">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
  </div>

  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ -->
  <div class="card shadow-sm mb-5">
    <div class="card-header bg-white border-bottom">
      <h5 class="mb-0">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h5>
    </div>
    <div class="card-body">
      {% if messages %}
        <div class="messages mb-3">
          {% for message in messages %}
            <div class="alert {{ message.tags }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <form method="post">
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-md-6">
            <label for="{{ staff_form.username.id_for_label }}" class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            {{ staff_form.username }}
            {% if staff_form.username.errors %}
              <div class="field-error">{{ staff_form.username.errors }}</div>
            {% endif %}
          </div>
          <div class="col-md-6">
            <label for="{{ staff_form.role.id_for_label }}" class="form-label">–†–æ–ª—å</label>
            {{ staff_form.role }}
            {% if staff_form.role.errors %}
              <div class="field-error">{{ staff_form.role.errors }}</div>
            {% endif %}
          </div>
          <div class="col-md-6">
            <label for="{{ staff_form.password1.id_for_label }}" class="form-label">–ü–∞—Ä–æ–ª—å</label>
            {{ staff_form.password1 }}
            {% if staff_form.password1.errors %}
              <div class="field-error">{{ staff_form.password1.errors }}</div>
            {% endif %}
          </div>
          <div class="col-md-6">
            <label for="{{ staff_form.password2.id_for_label }}" class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
            {{ staff_form.password2 }}
            {% if staff_form.password2.errors %}
              <div class="field-error">{{ staff_form.password2.errors }}</div>
            {% endif %}
          </div>
        </div>
        <div class="mt-3">
          <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
        </div>
      </form>
    </div>
  </div>

  <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
  <div class="row g-4 mb-5">
    <div class="col-md-4">
      <div class="card border-left-primary shadow-sm h-100">
        <div class="card-body text-center">
          <h5 class="card-title text-muted">–°—Ç—É–¥–µ–Ω—Ç—ã</h5>
          <h2 class="display-5 fw-bold text-primary">{{ role_counts.student }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-left-success shadow-sm h-100">
        <div class="card-body text-center">
          <h5 class="card-title text-muted">–ü–æ–≤–∞—Ä–∞</h5>
          <h2 class="display-5 fw-bold text-success">{{ role_counts.chef }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-left-danger shadow-sm h-100">
        <div class="card-body text-center">
          <h5 class="card-title text-muted">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</h5>
          <h2 class="display-5 fw-bold text-danger">{{ role_counts.admin }}</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
  <div class="card shadow-sm">
    <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
      <h5 class="mb-0">–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5>
      <div class="d-flex gap-2">
        <input type="text" id="userSearch" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏..." style="max-width: 250px;">
        <button id="deleteSelectedBtn" class="btn btn-danger" disabled>
          <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
        </button>
      </div>
    </div>
    <div class="card-body p-0">
      {% if users_with_roles %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th scope="col" class="px-4 py-3" style="width: 50px;">
                  <input type="checkbox" id="selectAll">
                </th>
                <th scope="col" class="px-4 py-3">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</th>
                <th scope="col" class="px-4 py-3">–†–æ–ª—å</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              {% for user in users_with_roles %}
                <tr class="user-row" data-username="{{ user.username|lower }}">
                  <td class="px-4 py-3">
                    <input type="checkbox" class="user-checkbox" value="{{ user.username }}">
                  </td>
                  <td class="px-4 py-3">{{ user.username }}</td>
                  <td class="px-4 py-3">
                    <span class="badge
                      {% if user.role == 'student' %}bg-primary
                      {% elif user.role == 'chef' %}bg-success
                      {% elif user.role == 'admin' %}bg-danger
                      {% else %}bg-secondary{% endif %}">
                      {{ user.role|title }}
                    </span>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-center py-4 text-muted">
          <p>–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
.border-left-primary { border-left: 4px solid #0d6efd !important; }
.border-left-success { border-left: 4px solid #198754 !important; }
.border-left-danger  { border-left: 4px solid #dc3545 !important; }
.card { transition: transform 0.2s; }
.card:hover { transform: translateY(-2px); }
.field-error {
  color: #f44336;
  font-size: 0.85em;
  margin-top: 5px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const searchInput = document.getElementById('userSearch');
  const selectAllCheckbox = document.getElementById('selectAll');
  const userCheckboxes = document.querySelectorAll('.user-checkbox');
  const deleteBtn = document.getElementById('deleteSelectedBtn');
  const userRows = document.querySelectorAll('.user-row');

  // –ü–æ–∏—Å–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–µ
  searchInput.addEventListener('input', function () {
    const query = this.value.trim().toLowerCase();
    userRows.forEach(row => {
      const username = row.dataset.username;
      if (username.includes(query)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });

  // –í—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ/—Å–Ω—è—Ç—å –≤—Å–µ
  selectAllCheckbox.addEventListener('change', function () {
    userCheckboxes.forEach(cb => cb.checked = this.checked);
    updateDeleteButton();
  });

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
  function updateDeleteButton() {
    const anyChecked = Array.from(userCheckboxes).some(cb => cb.checked);
    deleteBtn.disabled = !anyChecked;
  }

  userCheckboxes.forEach(cb => {
    cb.addEventListener('change', updateDeleteButton);
  });

  // –£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  deleteBtn.addEventListener('click', function () {
    const selectedUsernames = Array.from(userCheckboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.value);

    if (selectedUsernames.length === 0) return;

    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${selectedUsernames.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
      return;
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ AJAX-–∑–∞–ø—Ä–æ—Å–∞ –∏–ª–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    // –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ ‚Äî –æ—Ç–ø—Ä–∞–≤–∏–º —Ñ–æ—Ä–º—É POST
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "admin_users_delete_selected" %}';

    // CSRF —Ç–æ–∫–µ–Ω
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);

    // –ò–º–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    selectedUsernames.forEach(username => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'usernames';
      input.value = username;
      form.appendChild(input);
    });

    document.body.appendChild(form);
    form.submit();
  });
});
</script>
{% endblock %}