{% extends 'main/admin_dashboard/admin_base.html' %}
{% load static %}
{% block title %}Управление блюдами{%endblock %}
{% block body %}
{% if messages %}
<div class="messages">
    {% for message in messages %}
    {% if message.tags == 'error' %}
    <div class="alert alert-error">{{ message }}</div>
    {% else %}
    <div class="alert alert-success">{{ message }}</div>
    {% endif %}
    {% endfor %}
</div>
{% endif %}
<section class="menu-management" style="margin-top: 30px">
    <h2 class="dinner">Управление блюдами</h2>
    {% if cards %}
    <div class="dishes-filters">
        <button class="btn btn-primary rounded-pill px-3" type="button" onclick="showMeals('Все')">
        <i class="fas fa-spoon"></i>
        Все
        </button>
        <button class="btn btn-primary rounded-pill px-3" type="button" onclick="showMeals('Обед')">
        <i class="fas fa-plate-wheat"></i>
        Обеды
        </button>
        <button class="btn btn-primary rounded-pill px-3" type="button" onclick="showMeals('Завтрак')">
        <i class="fas fa-mug-saucer"></i>
        Завтраки
        </button>
        <button class="btn btn-info rounded-pill px-3" type="button" onclick="toggleVisibilityFilter()">
        <i class="fas fa-eye-slash"></i>
        <span id="visibilityToggleText">Показать скрытые</span>
        </button>
    </div>
    <div class="dishes-list">
        {% for card in cards %}
        <div class="dish-item" data-meal-type="{{ card.get_meal_type_display }}" data-hidden="{{ card.is_hidden|yesno:'true,false' }}">
            <div class="dish-header">
                <div>
                    <h3>{{ card.title }}</h3>
                    <div class="dish-rating mb-2">
                        {% if card.average_rating %}
                        <div class="star-rating small">
                            {% with avg_rating=card.average_rating %}
                                {% for i in "12345" %}
                                    {% if forloop.counter <= avg_rating %}
                                        <i class="fas fa-star text-warning"></i>
                                    {% elif forloop.counter|add:"-0.5" <= avg_rating %}
                                        <i class="fas fa-star-half-alt text-warning"></i>
                                    {% else %}
                                        <i class="far fa-star text-warning"></i>
                                    {% endif %}
                                {% endfor %}
                                <span class="ml-1">{{ avg_rating|floatformat:1 }}/5</span>
                                <span class="text-muted ml-2">({{ card.review_count }})</span>
                            {% endwith %}
                        </div>
                        {% else %}
                        <span class="text-muted small">Нет оценок</span>
                        {% endif %}
                    </div>
                    <span class="badge" style="background: #667eea; color: white">{{ card.get_meal_type_display }}</span>
                    {% if card.is_hidden %}
                    <span class="badge bg-warning text-dark" style="margin-left: 5px;">
                    <i class="fas fa-eye-slash"></i> Скрыто
                    </span>
                    {% endif %}
                </div>
                <span class="dish-price">ID: {{ card.id }}</span>
            </div>
            <p class="dish-desc">{{ card.description|default:"Без описания" }}</p>
            <span class="badge bg-success text-white" style="margin-left: 5px;">
                {{ card.price }} руб.
            </span>
            <div class="dish-actions">
                <form method="post" onsubmit="return confirm('Удалить блюдо «{{ card.title }}»?');" style="display: inline">
                    {% csrf_token %}
                    <input type="hidden" name="delete" value="1" />
                    <input type="hidden" name="card_id" value="{{ card.id }}" />
                    <button type="submit" class="btn-danger btn-sm">Удалить</button>
                </form>
                <form method="post" onsubmit="return confirm('{{ card.is_hidden|yesno:'Показать,Скрыть' }} блюдо «{{ card.title }}»?');" style="display: inline">
                    {% csrf_token %}
                    <input type="hidden" name="toggle_visibility" value="1" />
                    <input type="hidden" name="card_id" value="{{ card.id }}" />
                    <button type="submit" class="{{ card.is_hidden|yesno:'btn-success,btn-warning' }} btn-sm">
                    <i class="fas {{ card.is_hidden|yesno:'fa-eye,fa-eye-slash' }}"></i>
                    {{ card.is_hidden|yesno:'Показать,Скрыть' }}
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="color: #666; font-style: italic">Нет блюд</p>
    {% endif %}
</section>
{% endblock %}