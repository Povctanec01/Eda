{% extends 'main/chef_dashboard/chef_base.html' %}
{% load static %}
{% block title %}Управление блюдами{% endblock %}
{% block body %}
{% if messages %}
<div class="messages">
    {% for message in messages %}
    {% if message.tags == 'error' %}
    <div class="alert alert-error">
        {{ message }}
    </div>
    {% else %}
    <div class="alert alert-success">
        {{ message }}
    </div>
    {% endif %}
    {% endfor %}
</div>
{% endif %}

<div class="dashboard-header">
    <h1><i class="fas fa-utensils"></i> Управление блюдами</h1>
    <div class="header-stats">
        <div class="stat-card">
            <div class="stat-icon" style="background-color: #667eea;">
                <i class="fas fa-utensils"></i>
            </div>
            <div class="stat-info">
                <h3>{{ cards|length }}</h3>
                <p>Всего блюд</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background-color: #FF9800;">
                <i class="fas fa-eye-slash"></i>
            </div>
            <div class="stat-info">
                <h3>{{ hidden_count|default:"0" }}</h3>
                <p>Скрыто</p>
            </div>
        </div>
    </div>
</div>

<div class="dashboard-content">
    <!-- Форма добавления -->
    <div class="card mb-4">
        <div class="card-header">
            <h3><i class="fas fa-plus-circle"></i> Добавить новую карточку</h3>
        </div>
        <div class="card-body">
            <form method="post" class="preferences-form">
                {% csrf_token %}
                <input type="hidden" name="add" value="1">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.title.id_for_label }}">Название блюда *</label>
                            {{ form.title }}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="{{ form.price.id_for_label }}">Цена (руб.) *</label>
                            {{ form.price }}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="{{ form.meal_type.id_for_label }}">Тип приёма пищи *</label>
                            {{ form.meal_type }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="{{ form.description.id_for_label }}">Описание</label>
                            {{ form.description }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="{{ form.allergens.id_for_label }}">Аллергены</label>
                            <select name="allergens" id="id_allergens" class="form-control" multiple="multiple">
                                {% for allergen in form.allergens.field.queryset %}
                                <option value="{{ allergen.id }}">{{ allergen.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">
                                Начните вводить название аллергена для поиска
                            </small>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Добавить карточку
                </button>
            </form>
        </div>
    </div>

    <!-- Список для управления -->
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-list"></i> Список блюд ({{ cards|length }})</h3>
            <div class="dishes-filters">
                <div class="btn-group" role="group">
                    <button class="btn btn-primary rounded-pill px-3" type="button" onclick="showMeals('Все')">
                        <i class="fas fa-spoon"></i>
                        Все
                    </button>
                    <button class="btn btn-primary rounded-pill px-3" type="button" onclick="showMeals('Обед')">
                        <i class="fas fa-plate-wheat"></i>
                        Обеды
                    </button>
                    <button class="btn btn-primary rounded-pill px-3" type="button" onclick="showMeals('Завтрак')">
                        <i class="fas fa-mug-saucer"></i>
                        Завтраки
                    </button>
                </div>
                <div class="btn-group ml-2" role="group">
                    <button class="btn btn-info rounded-pill px-3" type="button" onclick="toggleVisibilityFilter()">
                        <i class="fas fa-eye-slash"></i>
                        Показать скрытые
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if cards %}
            <div class="dishes-list">
                {% for card in cards %}
                <!-- Основная строка блюда -->
                <div class="dish-item" data-meal-type="{{ card.get_meal_type_display }}" data-hidden="{{ card.is_hidden|yesno:'true,false' }}">
                    <div class="dish-header">
                        <div>
                            <h3>{{ card.title }}</h3>
                            <span class="badge" style="background: #667eea; color: white;">{{ card.get_meal_type_display }}</span>
                            <span class="badge bg-success text-white" style="margin-left: 5px;">
                                {{ card.price }} руб.
                            </span>
                            {% if card.is_hidden %}
                            <span class="badge bg-warning text-dark" style="margin-left: 5px;">
                                <i class="fas fa-eye-slash"></i> Скрыто
                            </span>
                            {% endif %}
                        </div>
                        <span class="dish-price">ID: {{ card.id }}</span>
                    </div>

                    <p class="dish-desc">{{ card.description|default:"Без описания" }}</p>

                    <!-- Отображение аллергенов -->
                    <div class="allergens-list" style="margin: 10px 0;">
                        {% if card.allergens.all %}
                        <strong>Аллергены:</strong>
                        {% for allergen in card.allergens.all %}
                        <span class="allergen-tag" style="background: #ff6b6b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin: 0 5px 5px 0; display: inline-block;">
                            {{ allergen.name }}
                        </span>
                        {% endfor %}
                        {% else %}
                        <span style="color: #666; font-style: italic;">Аллергены не указаны</span>
                        {% endif %}
                    </div>

                    <div class="dish-actions">
                        <!-- Кнопка редактирования -->
                        <button type="button"
                                class="btn btn-outline-primary btn-sm"
                                onclick="showEditForm('{{ card.id }}')"
                                title="Редактировать блюдо">
                            <i class="fas fa-edit"></i> Редактировать
                        </button>

                        <!-- Кнопка Скрыть/Показать -->
                        <form method="post" onsubmit="return confirm('{{ card.is_hidden|yesno:'Показать,Скрыть' }} блюдо «{{ card.title }}»?');"
                              style="display: inline; margin-left: 10px;">
                            {% csrf_token %}
                            <input type="hidden" name="toggle_visibility" value="1">
                            <input type="hidden" name="card_id" value="{{ card.id }}">
                            <button type="submit" class="btn {{ card.is_hidden|yesno:'btn-success,btn-warning' }} btn-sm">
                                <i class="fas {{ card.is_hidden|yesno:'fa-eye,fa-eye-slash' }}"></i>
                                {{ card.is_hidden|yesno:'Показать,Скрыть' }}
                            </button>
                        </form>

                        <!-- Кнопка Удалить -->
                        <form method="post" onsubmit="return confirm('Удалить блюдо «{{ card.title }}»?');"
                              style="display: inline; margin-left: 10px;">
                            {% csrf_token %}
                            <input type="hidden" name="delete" value="1">
                            <input type="hidden" name="card_id" value="{{ card.id }}">
                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-trash" style="color: #dc3545 !important;"></i> Удалить
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Скрытая форма для редактирования блюда -->
                <div id="edit-form-{{ card.id }}" class="edit-dish-form" style="display: none;">
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <form method="POST" class="edit-card-form">
                                {% csrf_token %}
                                <input type="hidden" name="edit_card" value="true">
                                <input type="hidden" name="card_id" value="{{ card.id }}">

                                <h5><i class="fas fa-edit"></i> Редактировать блюдо: {{ card.title }}</h5>

                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>Название блюда *</label>
                                            <input type="text"
                                                   name="title"
                                                   class="form-control"
                                                   value="{{ card.title }}"
                                                   required>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label>Цена (руб.) *</label>
                                            <input type="number"
                                                   name="price"
                                                   class="form-control"
                                                   value="{{ card.price }}"
                                                   step="0.01"
                                                   min="0"
                                                   required>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label>Тип приёма пищи *</label>
                                            <select name="meal_type" class="form-control" required>
                                                <option value="breakfast" {% if card.meal_type == 'breakfast' %}selected{% endif %}>Завтрак</option>
                                                <option value="lunch" {% if card.meal_type == 'lunch' %}selected{% endif %}>Обед</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label>Описание</label>
                                            <textarea name="description"
                                                      class="form-control"
                                                      rows="3">{{ card.description }}</textarea>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label>Аллергены</label>
                                            <select name="allergens" class="form-control" multiple="multiple">
                                                {% for allergen in form.allergens.field.queryset %}
                                                <option value="{{ allergen.id }}"
                                                        {% if allergen in card.allergens.all %}selected{% endif %}>
                                                    {{ allergen.name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <small class="form-text text-muted">
                                                Удерживайте Ctrl (Cmd на Mac) для выбора нескольких аллергенов
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mt-2">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <div class="form-check">
                                                <input type="checkbox"
                                                       name="is_hidden"
                                                       class="form-check-input"
                                                       id="is_hidden_{{ card.id }}"
                                                       {% if card.is_hidden %}checked{% endif %}>
                                                <label class="form-check-label" for="is_hidden_{{ card.id }}">
                                                    Скрыть блюдо (не показывать пользователям)
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Сохранить изменения
                                    </button>
                                    <button type="button" class="btn btn-secondary"
                                            onclick="hideEditForm('{{ card.id }}')">
                                        Отмена
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle fa-2x mb-3"></i>
                <h4>Нет блюд для управления</h4>
                <p>Добавьте блюда, используя форму выше.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function showEditForm(cardId) {
        // Скрываем все формы редактирования
        document.querySelectorAll('.edit-dish-form').forEach(form => {
            form.style.display = 'none';
        });
        // Показываем нужную форму
        document.getElementById('edit-form-' + cardId).style.display = 'block';
        // Прокручиваем к форме
        document.getElementById('edit-form-' + cardId).scrollIntoView({ behavior: 'smooth' });
    }

    function hideEditForm(cardId) {
        document.getElementById('edit-form-' + cardId).style.display = 'none';
    }

    function showMeals(type) {
        const dishes = document.querySelectorAll('.dish-item');
        dishes.forEach(dish => {
            const mealType = dish.dataset.mealType;
            const isHidden = dish.dataset.hidden === 'true';

            if (type === 'Все') {
                dish.style.display = 'block';
            } else if (type === mealType) {
                dish.style.display = 'block';
            } else {
                dish.style.display = 'none';
            }
        });
    }

    function toggleVisibilityFilter() {
        const dishes = document.querySelectorAll('.dish-item');
        dishes.forEach(dish => {
            const isHidden = dish.dataset.hidden === 'true';
            if (isHidden) {
                dish.style.display = dish.style.display === 'none' ? 'block' : 'none';
            }
        });
    }
</script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
{% endblock %}