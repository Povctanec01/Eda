{% extends 'main/chef_dashboard/chef_base.html' %}
{% load static %}
{% block title %}Управление блюдами{% endblock %}
{% block body %}
{% if messages %}
<div class="messages">
    {% for message in messages %}
    {% if message.tags == 'error' %}
    <div class="alert alert-error">
        {{ message }}
    </div>
    {% else %}
    <div class="alert alert-success">
        {{ message }}
    </div>
    {% endif %}
    {% endfor %}
</div>
{% endif %}
<!-- Форма добавления -->
<section class="menu-management">
    <h2><i class="fas fa-plus-circle"></i> Добавить новую карточку</h2>
    <form method="post" class="preferences-form">
        {% csrf_token %}
        <input type="hidden" name="add" value="1">
        <div class="form-group">
            <label for="{{ form.title.id_for_label }}">Название блюда:</label>
            {{ form.title }}
        </div>
        <div class="form-group">
            <label for="{{ form.description.id_for_label }}">Описание:</label>
            {{ form.description }}
        </div>
        <div class="form-group">
            <label for="{{ form.price.id_for_label }}">Цена (руб.):</label>
            {{ form.price }}
            <small class="form-text text-muted">
            Введите цену в рублях
            </small>
        </div>
        <div class="form-group">
            <label for="{{ form.meal_type.id_for_label }}">Тип приёма пищи:</label>
            {{ form.meal_type }}
        </div>
        <div class="form-group">
            <label for="{{ form.allergens.id_for_label }}">Аллергены:</label>
            <select name="allergens" id="id_allergens" class="form-control" multiple="multiple">
                {% for allergen in form.allergens.field.queryset %}
                <option value="{{ allergen.id }}">{{ allergen.name }}</option>
                {% endfor %}
            </select>
            <small class="form-text text-muted">
            Начните вводить название аллергена для поиска
            </small>
        </div>
        <button type="submit" class="btn-success">Добавить карточку</button>
    </form>
</section>
<!-- Список для управления -->
<section class="menu-management" style="margin-top: 30px;">
    <h2 class="dinner">Управление блюдами</h2>
    {% if cards %}
    <div class="dishes-filters">
        <button class="btn btn-primary rounded-pill px-3" type="button" onclick="showMeals('Все')">
        <i class="fas fa-spoon"></i>
        Все
        </button>
        <button class="btn btn-primary rounded-pill px-3" type="button" onclick="showMeals('Обед')">
        <i class="fas fa-plate-wheat"></i>
        Обеды
        </button>
        <button class="btn btn-primary rounded-pill px-3" type="button" onclick="showMeals('Завтрак')">
        <i class="fas fa-mug-saucer"></i>
        Завтраки
        </button>
        <button class="btn btn-info rounded-pill px-3" type="button" onclick="toggleVisibilityFilter()">
        <i class="fas fa-eye-slash"></i>
        Показать скрытые
        </button>
    </div>
    <div class="dishes-list">
        {% for card in cards %}
        <div class="dish-item" data-meal-type="{{ card.get_meal_type_display }}" data-hidden="{{ card.is_hidden|yesno:'true,false' }}">
            <div class="dish-header">
                <div>
                    <h3>{{ card.title }}</h3>
                    <span class="badge" style="background: #667eea; color: white;">{{ card.get_meal_type_display }}</span>
                    {% if card.is_hidden %}
                    <span class="badge bg-warning text-dark" style="margin-left: 5px;">
                    <i class="fas fa-eye-slash"></i> Скрыто
                    </span>
                    {% endif %}
                </div>
                <span class="dish-price">ID: {{ card.id }}</span>
            </div>
            <p class="dish-desc">{{ card.description|default:"Без описания" }}</p>
            <div class="dish-header">
                <div>
                    <h3>{{ card.title }}</h3>
                    <span class="badge" style="background: #667eea; color: white;">{{ card.get_meal_type_display }}</span>
                    <span class="badge bg-success text-white" style="margin-left: 5px;">
                    {{ card.price }} руб.
                    </span>
                    {% if card.is_hidden %}
                    <span class="badge bg-warning text-dark" style="margin-left: 5px;">
                    <i class="fas fa-eye-slash"></i> Скрыто
                    </span>
                    {% endif %}
                </div>
                <span class="dish-price">ID: {{ card.id }}</span>
            </div>
            <!-- Отображение аллергенов -->
            <div class="allergens-list" style="margin: 10px 0;">
                {% if card.allergens.all %}
                <strong>Аллергены:</strong>
                {% for allergen in card.allergens.all %}
                <span class="allergen-tag" style="background: #ff6b6b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin: 0 5px 5px 0; display: inline-block;">
                {{ allergen.name }}
                </span>
                {% endfor %}
                {% else %}
                <span style="color: #666; font-style: italic;">Аллергены не указаны</span>
                {% endif %}
            </div>
            <div class="dish-actions">
                <form method="post" onsubmit="return confirm('Удалить блюдо «{{ card.title }}»?');" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="delete" value="1">
                    <input type="hidden" name="card_id" value="{{ card.id }}">
                    <button type="submit" class="btn-danger btn-sm">Удалить</button>
                </form>
            </div>
            <div class="dish-actions">
                <form method="post" onsubmit="return confirm('{{ card.is_hidden|yesno:'Показать,Скрыть' }} блюдо «{{ card.title }}»?');" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="toggle_visibility" value="1">
                    <input type="hidden" name="card_id" value="{{ card.id }}">
                    <button type="submit" class="{{ card.is_hidden|yesno:'btn-success,btn-warning' }} btn-sm">
                    <i class="fas {{ card.is_hidden|yesno:'fa-eye,fa-eye-slash' }}"></i>
                    {{ card.is_hidden|yesno:'Показать,Скрыть' }}
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="color: #666; font-style: italic;">Нет блюд для управления.</p>
    {% endif %}
</section>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
{% endblock %}