{% extends 'main/chef_dashboard/chef_base.html' %}
{% load static %}
{% block title %}Панель повара - Школьная Столовая{% endblock %}
{% block body %}
<main class="main-content">
<header class="top-bar">
  <div class="top-bar-left">
    <h1>Доброй день, {{ user.username }}!</h1>
    <p>Сегодня: <span id="currentDate">Загрузка...</span></p>
  </div>
  <div class="top-bar-right">
    <div class="notification-bell" onclick="showNotifications()">
      <i class="fas fa-bell"></i>
      <span class="badge">5</span>
    </div>
    <div class="kitchen-status">
      <span class="status-indicator active"></span>
      <span>Кухня работает</span>
      <button class="btn btn-sm btn-outline" onclick="toggleKitchenStatus()">
        <i class="fas fa-power-off"></i> Статус
      </button>
    </div>
  </div>
</header>

<div id="dashboard" class="dashboard-section active">
  <section class="dashboard-cards">
    <div class="card">
      <div class="card-icon bg-orange">
        <i class="fas fa-clock"></i>
      </div>
      <div class="card-content">
        <h3>Текущие заказы</h3>
        <p class="card-value">{{ chef_active_orders_count }}</p>
        <p class="card-desc">Ожидают приготовления</p>
        {% if chef_active_orders_count > 3 %}
          <a href="{% url 'chef_orders' %}" class="btn btn-sm btn-outline">Посмотреть все</a>
        {% endif %}
      </div>
    </div>
    <!-- остальные карточки можно оставить как есть -->
    <div class="card">
      <div class="card-icon bg-green">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="card-content">
        <h3>Выполнено сегодня</h3>
        <p class="card-value">24</p>
        <p class="card-desc">Блюд приготовлено</p>
        <button class="btn btn-sm btn-outline" onclick="showDailyStats()">Статистика</button>
      </div>
    </div>
    <div class="card">
      <div class="card-icon bg-blue">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="card-content">
        <h3>Низкие остатки</h3>
        <p class="card-value">3</p>
        <p class="card-desc">Продуктов</p>
        <button class="btn btn-sm btn-outline" onclick="showSection('inventory')">Проверить</button>
      </div>
    </div>
  </section>

  <div class="dashboard-grid">
    <section class="orders-section">
      <div class="section-header">
        <h2><i class="fas fa-concierge-bell"></i> Активные заказы</h2>
        {% if orders %}
          <button class="btn btn-primary" onclick="markAllPrepared()">
            <i class="fas fa-check-double"></i> Отметить все готовыми
          </button>
        {% endif %}
      </div>
      <div class="orders-list">
        {% for order in orders %}
          <div class="order-item" id="order-{{ order.id }}">
            <div class="order-header">
              <div class="order-number">
                <strong>#{{ order.id }}</strong>
                <span class="order-time">{{ order.ordered_at|date:"H:i" }}</span>
              </div>
              <div class="student-info">
                <i class="fas fa-user-graduate"></i>
                <span>{{ order.user.get_full_name|default:order.user.username }}</span>
              </div>
            </div>
            <div class="order-details">
              <div class="meal-info">
                <h4>{{ order.card.title|default:"[Удалено]" }}</h4>
                <p class="meal-ingredients">
                  {% if order.card.ingredients %}
                    {{ order.card.ingredients }}
                  {% else %}
                    Без ингредиентов
                  {% endif %}
                </p>
                {% if order.card.allergens %}
                  <div class="allergy-warning">
                    <i class="fas fa-exclamation-circle text-danger"></i>
                    <span class="text-danger">Аллергия: {{ order.card.allergens }}</span>
                  </div>
                {% endif %}
              </div>
              <div class="order-actions">
                {% if order.status == 'pending' %}
                  <span class="badge bg-orange">В ожидании</span>
                  <form method="post" style="display:inline;" onsubmit="markAsReady(event, {{ order.id }})">
                    {% csrf_token %}
                    <input type="hidden" name="order_id" value="{{ order.id }}">
                    <button type="submit" class="btn btn-success btn-sm">
                      <i class="fas fa-check"></i> Готово
                    </button>
                  </form>
                {% elif order.status == 'ready' %}
                  <span class="badge bg-success">✓ Готово</span>
                {% endif %}
              </div>
            </div>
          </div>
        {% empty %}
          <p class="text-muted">Нет активных заказов.</p>
        {% endfor %}
      </div>
      {% if all_orders_count > 3 %}
        <div class="mt-3 text-center">
          <a href="{% url 'chef_orders' %}" class="btn btn-outline-secondary">
            Посмотреть все заказы
          </a>
        </div>
      {% endif %}
    </section>
  </div>
    <section class="inventory-section">
      <div class="section-header">
        <h2><i class="fas fa-boxes"></i> Заявки на закупку</h2>
        <a href="{% url 'chef_buys' %}" class="btn btn-primary" onclick="openPurchaseModal()">
          <i class="fas fa-plus"></i> Новая заявка
        </a>
      </div>
          <h2>Заказы</h2>

          {% if buys %}

          <div class="dishes-list">
            {% for card_buys in buys %}
              <div class="dish-item" data-meal-type="{{ card_buys.get_meal_type_display }}">
                <div class="dish-header">
                  <div>
                    <h3>{{ card_buys.title }}</h3>
                  </div>
                  <span class="dish-price">ID: {{ card_buys.id }}</span>
                </div>
                <p class="dish-desc">{{ card_buys.description|default:"Без описания" }}</p>
                <div class="dish-actions">
                  <form method="post" onsubmit="return confirm('Удалить блюдо «{{ card_buys.title }}»?');" style="display: inline;">
                    {% csrf_token %}
                        <input type="hidden" name="delete" value="1">
                        <input type="hidden" name="card_id_buys" value="{{ card_buys.id }}">
                        <button type="submit" class="btn-danger btn-sm">Удалить</button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
          {% else %}
            <p style="color: #666; font-style: italic;">Нет Активных заявок</p>
          {% endif %}
    </section>
    </div>
</main>
{% endblock %}